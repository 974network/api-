<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>التقاط صورة وإرسالها عبر GAS</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;display:flex;flex-direction:column;gap:10px;align-items:center;padding:18px}
  video, canvas{border-radius:8px;max-width:100%;width:480px;background:#000}
  button{padding:8px 12px;border-radius:8px;cursor:pointer}
  #status{font-size:14px;color:#222}
</style>
</head>
<body>
  <h3>التقاط صورة وإرسالها إلى الإيميل</h3>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none"></canvas>

  <div>
    <button id="start">فتح الكاميرا والتقاط صورة</button>
    <button id="stop" disabled>إيقاف الكاميرا</button>
  </div>

  <p id="status">جاهز</p>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzYBXwQTyonHkaPOomhQB2RF6X2uk37_YiZEtl6B5JWCIarDYXd1mc-9cqFjJdR8Cg/exec"; // ضع هنا رابط Web App المنشور من GAS

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const status = document.getElementById('status');
let stream = null;

async function startCamera() {
  status.textContent = 'طلب صلاحية الكاميرا...';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    status.textContent = 'الكاميرا تعمل. سيتم التقاط صورة بعد 700 ملليثانية...';
    await new Promise(r => setTimeout(r, 700));
    await captureAndSend();
  } catch (err) {
    console.error(err);
    status.textContent = 'خطأ: لم تُمنح صلاحية الكاميرا أو الجهاز لا يدعمها.';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
    status.textContent = 'تم إيقاف الكاميرا';
  }
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

async function captureAndSend() {
  if (!stream) { status.textContent = 'الكاميرا غير متاحة'; return; }

  canvas.width = video.videoWidth || 1280;
  canvas.height = video.videoHeight || 720;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

  status.textContent = 'جارٍ إرسال الصورة...';

  try {
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename: 'capture_' + Date.now() + '.jpg',
        image: dataUrl
      })
    });

    const json = await res.json().catch(()=>({}));
    if (res.ok) {
      status.textContent = 'تم الإرسال. الخادم رد: ' + (json.status || 'ok');
    } else {
      status.textContent = 'فشل الإرسال: ' + (json.error || res.statusText);
    }
  } catch (err) {
    console.error(err);
    status.textContent = 'خطأ في الاتصال بخادم GAS.';
  } finally {
    // إيقاف الكاميرا تلقائياً بعد الإرسال
    stopCamera();
  }
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
</script>
</body>
</html>
